<!DOCTYPE html>

<html>
  <meta charset="UTF-8">
  <title>League By Day</title>
  <script src="http://d3js.org/d3.v3.min.js"  charset="utf-8"></script>

  <style>
  text {
    font: 10px sans-serif;
  }

  .axis line,
  .axis path {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .win {
    fill: steelblue;
  }

  .loss {
    fill: brown;
  }

  .average {
    stroke: #888;
  }

  .zero {
    stroke: #000;
  }

  .day:nth-child(odd) .highlight {
    fill: white;
  }

  .day:nth-child(even) .highlight {
    fill: khaki;
  }

  .legend polyline {
    fill: none;
  }
  </style>

<body>
<svg id="chart" />

<script>

var margin = {top: 30, right: 100, bottom: 100, left: 100},
    width  = 800 - margin.left - margin.right,   /* width  of drawing area */
    height = 600 - margin.top  - margin.bottom;  /* height of drawing area */

var barwidth  = width / 8;
var barheight = height / 24;

/** setup X axis **************************************************************/

var dayNames = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

var formatWeekday = function (d) {
  return dayNames[d];
}

var weekdayToX = d3.scale.linear()
  .domain([-.5,6.5])
  .range([0,width])
;

var xAxis = d3.svg.axis()
  .scale(weekdayToX)
  .orient("top")
  .tickFormat(formatWeekday)
;

/** setup Y axis **************************************************************/

var hourToY = d3.scale.linear()
  .domain([0,24])
  .range([0,height])
;

var formatHour = function (d) {
  if (d % 24 == 0)
    return "midnight";
  else if (d % 12 == 0)
    return "noon";
  else
    return (d % 12) + ":00 " + (d % 24 < 12 ? "am" : "pm");
};

var yAxis = d3.svg.axis()
  .scale(hourToY)
  .orient("left")
  .tickFormat(formatHour)
;

/** setup chart ***************************************************************/

var chart = d3.select("#chart")
  .attr("width",  width  + margin.left + margin.right)
  .attr("height", height + margin.top  + margin.bottom)
;

var area = chart.append("g")
  .attr("id", "area")
  .attr("transform", "translate(" + margin.left + "," + margin.right + ")");
;

area.append("g")
  .attr("class", "y axis")
  .call(yAxis)
;

area.append("g")
  .attr("class", "x axis")
  .call(xAxis)
;

/** Adding data (after load) **************************************************/

d3.json("data.json", function(error, input) {

  /** bucket data */
  var data = new Array(7);
  for (var day = 0; day < 7; day++) {
    data[day] = new Array(24);
    for (var hour = 0; hour < 24; hour++)
      data[day][hour] = {day:day, hour:hour, wins: 0, losses: 0};
  }

  var totalWins = 0, totalLosses = 0;
  for (var i in input) {
    match = input[i];
    date  = new Date(match.timestamp);
    entry = data[date.getDay()][date.getHours()];
    if (match.winner) {
      entry.wins++;
      totalWins++;
    }
    else {
      entry.losses++;
      totalLosses++;
    }
  }

  var maxGames =
    d3.max(data, function (row) {
      return d3.max (row, function (cell) {
        return cell.wins + cell.losses;
      })
    })
  ;

  var winPercent = totalWins / (totalWins + totalLosses);

  var countToHeight = d3.scale.linear()
    .domain([0, maxGames])
    .range([0,barheight/2])
  ;
  
  var percentToWidth = d3.scale.linear()
    .domain([0,1])
    .range([0,barwidth/2])
  ;

  /** legend ******************************************************************/

  legend = area.append("g")
    .attr("class", "legend")
    .attr("transform",
          "translate(" + (weekdayToX(0) + percentToWidth(winPercent)) + ", " + height + ")")
  ;

  legend.append("polyline")
    .attr("class", "average")
    .attr("points", "0,0 0,20 20,20")
  ;

  legend.append("text")
    .attr("x", 20).attr("y", 20)
    .attr("dy", ".35em")
    .text("win rate: " + Math.round(100 * winPercent) + "%")
  ;

  /** column for day **********************************************************/

  var day = area.selectAll(".day")
    .data(data)
    .enter().append("g")
      .attr("class", "day")
      .attr("transform", function (d,i) { return "translate(" + weekdayToX(i) + ",0)"; })
  ;

  day.append("rect")
    .attr("class", "highlight")
    .attr("x", percentToWidth(-1))
    .attr("y", 0)
    .attr("width", 2*percentToWidth(1))
    .attr("height", height)
  ;

  day.append("line")
    .attr("class", "average")
    .attr("y1",      0).attr("x1", percentToWidth(winPercent))
    .attr("y2", height).attr("x2", percentToWidth(winPercent))
  ;

  day.append("line")
    .attr("class", "average")
    .attr("y1",      0).attr("x1", -percentToWidth(1-winPercent))
    .attr("y2", height).attr("x2", -percentToWidth(1-winPercent))
  ;

  day.append("line")
    .attr("class", "zero")
    .attr("x1", 0).attr("y1", 0)
    .attr("x2", 0).attr("y2", height)
  ;

  /** bar charts for each time slot *******************************************/

  var time = day.selectAll(".time")
    .data(function (d) { return d; })
    .enter().append("g")
      .attr("class", "time")
      .attr("transform", function (d,i) { return "translate(0," + hourToY(i + .5) + ")"; })
  ;

  var barPoints = function (wins, losses) {
    var games = wins + losses;
    var y = countToHeight(games);
    var x = percentToWidth(wins/games);
    return    0 + "," + y
      + " " + x + "," + y
      + " " + x + "," + -y
      + " " + 0 + "," + -y;
  }
  
  time.append("polyline")
    .attr("class", "win")
    .attr("points", function (d) { return barPoints(d.wins, d.losses); })
  ;
  
  time.append("polyline")
    .attr("class", "loss")
    .attr("transform", "scale(-1,1)")
    .attr("points", function (d) { return barPoints(d.losses, d.wins); })
  ;

});

</script>

</body>

</html>
