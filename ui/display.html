<!DOCTYPE html>

<html>
  <meta charset="UTF-8">
  <title>League By Day</title>
  <script src="d3.v3.min.js" charset="utf-8"></script>

  <style>
  text {
    font: 10px sans-serif;
  }

  .axis line,
  .axis path {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .win {
    fill: steelblue;
  }

  .loss {
    fill: brown;
  }

  .average {
    stroke: #888;
  }

  .zero {
    stroke: #000;
  }

  .day:nth-child(odd) .highlight {
    fill: white;
  }

  .day:nth-child(even) .highlight {
    fill: khaki;
  }

  .legend polyline {
    fill: none;
  }

  #guide {
    stroke: #000;
  }
  </style>

<body>
<svg id="chart" />

<script>

/** Constants *****************************************************************/

var margin = {top: 30, right: 100, bottom: 100, left: 100},
    width  = 800 - margin.left - margin.right,   /* width  of drawing area */
    height = 600 - margin.top  - margin.bottom;  /* height of drawing area */

var barwidth  = width / 7;
var barheight = height / 24;

var extraHours = 6;

/** Layers ********************************************************************/

var chart = d3.select("#chart")
  .attr("width",  width  + margin.left + margin.right)
  .attr("height", height + margin.top  + margin.bottom)
;

var clipPath = chart.append("defs").append("clipPath")
  .attr("id", "areaClip")
  .append("rect")
    .attr("x", 0).attr("y", 0)
    .attr("width", width).attr("height", height)
;

var backgroundLayer = chart.append("g")
  .attr("id", "background")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
;

var guideLayer = chart.append("g")
  .attr("id", "guide")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
;

var dataLayer = chart.append("g")
  .attr("id", "dataLayer")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
  .attr("clip-path", "url(#areaClip)")
;

var eventLayer = chart.append("g")
  .attr("id", "eventLayer")
  .attr("pointer-events", "all")
  .attr("visibility", "hidden")
;

/** setup X axis **************************************************************/

var dayNames = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

var formatWeekday = function (d) {
  return dayNames[d];
}

var weekdayToX = d3.scale.linear()
  .domain([-.5,6.5])
  .range([0,width])
;

var xAxis = d3.svg.axis()
  .scale(weekdayToX)
  .orient("top")
  .tickFormat(formatWeekday)
;

/** setup Y axis **************************************************************/

var hourToY = d3.scale.linear()
  .domain([0,24])
  .range([0,height])
;

var formatHour = function (d) {
  if (d % 24 == 0)
    return "midnight";
  else if (d % 12 == 0)
    return "noon";
  else
    return (d % 12) + ":00 " + (d % 24 < 12 ? "am" : "pm");
};

var yAxis = d3.svg.axis()
  .scale(hourToY)
  .orient("left")
  .tickFormat(formatHour)
;

/** Axes **********************************************************************/

backgroundLayer.append("g")
  .attr("class", "y axis")
  .call(yAxis)
;

backgroundLayer.append("g")
  .attr("class", "x axis")
  .call(xAxis)
;

/** guideline *****************************************************************/

eventArea = eventLayer.append("rect")
  .attr("x", margin.left).attr("y", margin.top)
  .attr("width", width)
  .attr("height", height)
;

guide = guideLayer.append("line")
  .attr("x1",     0).attr("y1", 0)
  .attr("x2", width).attr("y2", 0)
;

eventArea
  .on('mouseover', function () {
    guide.attr("visibility", "visible");
  })
  .on('mousemove', function () {
    var y = d3.mouse(guideLayer.node())[1];
    guide.attr("transform", "translate(" + 0 + "," + y + ")");
  })
  .on('mouseout',  function () {
    guide.attr("visibility", "hidden");
  })
;


/** Adding data (after load) **************************************************/

d3.json("data.json", function(error, input) {

  /** bucket data */
  var data = new Array(7);
  for (var day = 0; day < 7; day++) {
    data[day] = new Array(24 + 2*extraHours);
    for (var hour = 0 - extraHours; hour < 24 + extraHours; hour++) {
      data[day][hour + extraHours] = {day:day, hour:hour, wins: 0, losses: 0};
    }
  }

  var totalWins = 0, totalLosses = 0;
  for (var i in input) {
    var match = input[i];
    var date  = new Date(match.timestamp);

    var day     = date.getDay(), hour = date.getHours();
    var tmrwDay = (day + 1) % 7, tmrwHour = hour - 24;
    var ystrDay = (day - 1) % 7, ystrHour = hour + 24;

    if (ystrDay < 0) ystrDay += 7;

    var entries = [data[day][extraHours + hour]];

    if (tmrwHour + extraHours >= 0)
      entries.push(data[tmrwDay][extraHours + tmrwHour]);

    if (ystrHour + extraHours < data[ystrDay].length)
      entries.push(data[ystrDay][extraHours + ystrHour]);

    for (var j in entries) {
      if (match.winner) {
        entries[j].wins++;
        totalWins++;
      }
      else {
        entries[j].losses++;
        totalLosses++;
      }
    }
  }

  var maxGames =
    d3.max(data, function (row) {
      return d3.max (row, function (cell) {
        return cell.wins + cell.losses;
      })
    })
  ;

  var winPercent = totalWins / (totalWins + totalLosses);

  var countToHeight = d3.scale.linear()
    .domain([0, maxGames])
    .range([0,barheight/2])
  ;
  
  var percentToWidth = d3.scale.linear()
    .domain([0,1])
    .range([0,barwidth/2])
  ;

  /** legend ******************************************************************/

  legend = backgroundLayer.append("g")
    .attr("class", "legend")
    .attr("transform",
          "translate(" + (weekdayToX(0) + percentToWidth(winPercent)) + ", " + height + ")")
  ;

  legend.append("polyline")
    .attr("class", "average")
    .attr("points", "0,0 0,20 20,20")
  ;

  legend.append("text")
    .attr("x", 20).attr("y", 20)
    .attr("dy", ".35em")
    .text("win rate: " + Math.round(100 * winPercent) + "%")
  ;

  /** column for day **********************************************************/

  var day = dataLayer.selectAll(".day")
    .data(data)
    .enter().append("g")
      .attr("class", "day")
      .attr("transform", function (d,i) { return "translate(" + weekdayToX(i) + ",0)"; })
  ;

  day.append("rect")
    .attr("class", "highlight")
    .attr("x", percentToWidth(-1))
    .attr("y", 0)
    .attr("width", 2*percentToWidth(1))
    .attr("height", height)
  ;

  day.append("line")
    .attr("class", "average")
    .attr("y1",      0).attr("x1", percentToWidth(winPercent))
    .attr("y2", height).attr("x2", percentToWidth(winPercent))
  ;

  day.append("line")
    .attr("class", "average")
    .attr("y1",      0).attr("x1", -percentToWidth(1-winPercent))
    .attr("y2", height).attr("x2", -percentToWidth(1-winPercent))
  ;

  day.append("line")
    .attr("class", "zero")
    .attr("x1", 0).attr("y1", 0)
    .attr("x2", 0).attr("y2", height)
  ;

  /** bar charts for each time slot *******************************************/

  var time = day.selectAll(".time")
    .data(function (d) { return d; })
    .enter().append("g")
      .attr("class", "time")
      .attr("transform", function (d) { return "translate(0," + hourToY(d.hour + .5) + ")"; })
  ;

  var barPoints = function (wins, losses) {
    var games = wins + losses;
    var y = countToHeight(games);
    var x = percentToWidth(wins/games);
    return    0 + "," + y
      + " " + x + "," + y
      + " " + x + "," + -y
      + " " + 0 + "," + -y;
  }
  
  time.append("polyline")
    .attr("class", "win")
    .attr("points", function (d) { return barPoints(d.wins, d.losses); })
  ;
  
  time.append("polyline")
    .attr("class", "loss")
    .attr("transform", "scale(-1,1)")
    .attr("points", function (d) { return barPoints(d.losses, d.wins); })
  ;

});

</script>

</body>

</html>
