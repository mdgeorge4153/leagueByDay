<!DOCTYPE html>

<html>
  <meta charset="UTF-8">
  <title>League By Day</title>
  <script src="http://d3js.org/d3.v3.min.js"  charset="utf-8"></script>

  <style>
  text {
    font: 10px sans-serif;
  }

  .axis line,
  .axis path {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .win {
    fill: steelblue;
  }

  .loss {
    fill: brown;
  }

  .average {
    stroke: #888;
  }

  .zero {
    stroke: #000;
  }

  .day:nth-child(odd) .highlight {
    fill: white;
  }

  .day:nth-child(even) .highlight {
    fill: lemonchiffon;
  }
  </style>

<body>
<svg id="chart" />

<script>

var margin = {top: 10, right: 100, bottom: 100, left: 100},
    width  = 600 - margin.left - margin.right,
    height = 600 - margin.top  - margin.bottom;

var barwidth  = width / 24;
var barheight = height / 9;

var formatWeekday = function (d) {
  var weekdays = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
  return weekdays[d];
}

var weekdayToY = d3.scale.linear()
  .domain([-1,7])
  .range([0,height])
;

var yAxis = d3.svg.axis()
  .scale(weekdayToY)
  .orient("left")
  .tickFormat(formatWeekday)
;

var hourToX = d3.scale.linear()
  .domain([0,24])
  .range([0,width])
;

var formatHour = function (d) {
  if (d % 24 == 0)
    return "midnight";
  else if (d % 12 == 0)
    return "noon";
  else
    return (d % 12) + ":00";
};

var xAxis = d3.svg.axis()
  .scale(hourToX)
  .orient("bottom")
  .tickFormat(formatHour)
;

var chart = d3.select("#chart")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
;

var area = chart.append("g")
  .attr("id", "area")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
;

area.append("g")
  .attr("class", "y axis")
  .call(yAxis)
;

area.append("g")
  .attr("class", "x axis")
  .attr("transform", "translate(0," + height + ")")
  .call(xAxis)
  .selectAll("text")
    .attr("y", 0)
    .attr("x", -9)
    .attr("dy", ".35em")
    .attr("transform", "rotate(-90)")
    .style("text-anchor", "end")
;

d3.json("data.json", function(error, input) {

  var data = new Array(7);
  for (var day = 0; day < 7; day++) {
    data[day] = new Array(24);
    for (var hour = 0; hour < 24; hour++)
      data[day][hour] = {day:day, hour:hour, wins: 0, losses: 0};
  }

  var totalWins = 0, totalLosses = 0;
  for (var i in input) {
    match = input[i];
    date  = new Date(match.timestamp);
    entry = data[date.getDay()][date.getHours()];
    if (match.winner) {
      entry.wins++;
      totalWins++;
    }
    else {
      entry.losses++;
      totalLosses++;
    }
  }

  var maxGames =
    d3.max(data, function (row) {
      return d3.max (row, function (cell) {
        return cell.wins + cell.losses;
      })
    })
  ;

  var winPercent = totalWins / (totalWins + totalLosses);

  var countToWidth = d3.scale.linear()
    .domain([0, maxGames])
    .range([0,barwidth/2])
  ;
  
  var percentToHeight = d3.scale.linear()
    .domain([0,1])
    .range([0,barheight/2-5])
  ;

  legend = area.append("g")
    .attr("class", "legend")
    .attr("transform",
          "translate(" + width + ", " + (weekdayToY(0) - percentToHeight(winPercent)) + ")")
  ;

  legend.append("line")
    .attr("class", "average")
    .attr("x1", 0).attr("y1", 0)
    .attr("x2", 10).attr("y2", 0)
  ;

  legend.append("text")
    .attr("x", 10).attr("y", 0)
    .attr("dy", ".35em")
    .text("win rate: " + Math.round(100 * winPercent) + "%")
  ;
  
  var day = area.selectAll(".day")
    .data(data)
    .enter().append("g")
      .attr("class", "day")
      .attr("transform", function (d,i) { return "translate(0," + weekdayToY(i) + ")"; })
  ;

  day.append("rect")
    .attr("class", "highlight")
    .attr("x", 0).attr("y", -barheight/2)
    .attr("width", width).attr("height", barheight)
  ;

  day.append("line")
    .attr("class", "average")
    .attr("x1",     0).attr("y1", -percentToHeight(winPercent))
    .attr("x2", width).attr("y2", -percentToHeight(winPercent))
  ;

  day.append("line")
    .attr("class", "average")
    .attr("x1",     0).attr("y1", percentToHeight(1-winPercent))
    .attr("x2", width).attr("y2", percentToHeight(1-winPercent))
  ;

  day.append("line")
    .attr("class", "zero")
    .attr("x1", 0).attr("y1", 0)
    .attr("x2", width).attr("y2", 0)
  ;


  var time = day.selectAll(".time")
    .data(function (d) { return d; })
    .enter().append("g")
      .attr("class", "time")
      .attr("transform", function (d,i) { return "translate(" + hourToX(i + .5) + ",0)"; })
  ;

  var barPoints = function (wins, losses) {
    var games = wins + losses;
    var x = countToWidth(games);
    var y = percentToHeight(wins/games);
    return     x + "," + 0
      + " " +  x + "," + y
      + " " + -x + "," + y
      + " " + -x + "," + 0;
  }
  
  time.append("polyline")
    .attr("class", "win")
    .attr("transform", "scale(1,-1)")
    .attr("points", function (d) { return barPoints(d.wins, d.losses); })
  ;
  
  time.append("polyline")
    .attr("class", "loss")
    .attr("points", function (d) { return barPoints(d.losses, d.wins); })
  ;

});

</script>

</body>

</html>
